<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Clips Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@4.2.0/dist/tus.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <style>
    body { padding: 20px; }
    .video-card { cursor: pointer; }
    #upload-drop { border: 2px dashed #ccc; padding: 20px; text-align: center; }
    #upload-drop.dragover { border-color: #000; }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="login" class="container">
    <h1>Login</h1>
    <form id="login-form">
      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary">Login</button>
    </form>
  </div>

  <!-- Homepage Section -->
  <div id="home" class="container" style="display: none;">
    <h1>Game Clips</h1>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <input id="search-bar" class="form-control me-2" type="search" placeholder="Search by name" aria-label="Search">
        <select id="filter-select" class="form-select me-2">
          <option value="">All Categories/Games</option>
          <!-- Populated dynamically -->
        </select>
        <select id="sort-select" class="form-select me-2">
          <option value="desc">Date: Newest First</option>
          <option value="asc">Date: Oldest First</option>
        </select>
        <button id="upload-btn" class="btn btn-success">Upload Clip</button>
      </div>
    </nav>
    <div id="video-list" class="row mt-3"></div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="upload-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Game Clip</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="upload-drop">Drag & drop file here or <input type="file" id="file-input" accept="video/*"></div>
          <div id="upload-progress" class="progress mt-3" style="display: none;">
            <div class="progress-bar" role="progressbar" style="width: 0%;"></div>
          </div>
          <div id="metadata-form" style="display: none;" class="mt-3">
            <input id="video-name" class="form-control mb-2" placeholder="Name">
            <input id="video-category" class="form-control mb-2" placeholder="Category/Game (new if not exist)">
            <button id="submit-metadata" class="btn btn-primary">Upload</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video View Modal -->
  <div class="modal fade" id="video-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="video-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <iframe id="video-player" width="100%" height="400" frameborder="0" allowfullscreen></iframe>
          <div class="mt-3">
            <label>Start Time (seconds)</label>
            <input id="trim-start" type="number" class="form-control d-inline-block w-25 me-2" min="0" value="0">
            <label>End Time (seconds)</label>
            <input id="trim-end" type="number" class="form-control d-inline-block w-25 me-2" min="1">
            <button id="save-new" class="btn btn-primary me-2">Save as New</button>
            <button id="override" class="btn btn-warning me-2">Override Original</button>
            <button id="share-btn" class="btn btn-info">Share Link</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LIBRARY_ID = 'your_library_id_here'; // Replace
    const API_KEY = 'your_api_key_here'; // Replace
    const HOSTNAME = 'yourhostname.b-cdn.net'; // Replace
    const API_BASE = 'https://video.bunnycdn.com/library/' + LIBRARY_ID + '/';
    const IFRAME_BASE = 'https://iframe.mediadelivery.net/embed/' + LIBRARY_ID + '/';
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    // API Helper
    async function apiCall(method, path, body = null) {
      const url = API_BASE + path;
      const headers = { 'AccessKey': API_KEY };
      if (body && method !== 'PUT') headers['Content-Type'] = 'application/json';
      const res = await fetch(url, { method, headers, body });
      if (!res.ok) throw new Error(await res.text());
      return method !== 'DELETE' ? await res.json() : null;
    }

    // SHA256 for signature
    async function getSignature(videoId, expire) {
      const data = new TextEncoder().encode(LIBRARY_ID + API_KEY + expire + videoId);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Upload with TUS
    async function uploadVideo(file, title, collectionId) {
      const createRes = await apiCall('POST', 'videos', { title, collectionId });
      const videoId = createRes.guid;
      const expire = Math.floor(Date.now() / 1000) + 3600; // 1 hour
      const signature = await getSignature(videoId, expire);
      return new Promise((resolve, reject) => {
        const upload = new tus.Upload(file, {
          endpoint: 'https://video.bunnycdn.com/tusupload',
          headers: {
            AuthorizationSignature: signature,
            AuthorizationExpire: expire.toString(),
            VideoId: videoId,
            LibraryId: LIBRARY_ID
          },
          metadata: {
            filetype: file.type,
            title: title,
            collection: collectionId
          },
          chunkSize: 50 * 1024 * 1024,
          retryDelays: [0, 3000, 5000, 10000, 20000],
          onError: reject,
          onProgress: (uploaded, total) => {
            document.querySelector('#upload-progress .progress-bar').style.width = `${(uploaded / total * 100)}%`;
          },
          onSuccess: () => resolve(videoId)
        });
        upload.findPreviousUploads().then(prev => {
          if (prev.length) upload.resumeFromPreviousUpload(prev[0]);
          upload.start();
        });
      });
    }

    // Load Collections for Filter
    async function loadCollections() {
      try {
        const res = await apiCall('GET', 'collections?itemsPerPage=100');
        const select = document.getElementById('filter-select');
        res.items.forEach(col => {
          const opt = document.createElement('option');
          opt.value = col.guid;
          opt.textContent = col.name;
          select.appendChild(opt);
        });
      } catch (e) { console.error('Collections load failed:', e); }
    }

    // Load Videos
    async function loadVideos(search = '', collectionId = '', sort = 'desc') {
      try {
        let params = 'videos?itemsPerPage=100&orderBy=date';
        if (search) params += `&search=${encodeURIComponent(search)}`;
        if (collectionId) params += `&collection=${collectionId}`;
        let videos = (await apiCall('GET', params)).items || [];
        // Client-side sort if needed (API orderBy is desc by default)
        videos.sort((a, b) => sort === 'desc' ? b.dateUploaded - a.dateUploaded : a.dateUploaded - b.dateUploaded);
        const list = document.getElementById('video-list');
        list.innerHTML = '';
        videos.forEach(video => {
          if (video.status !== 4) return; // Skip if not ready
          const card = document.createElement('div');
          card.className = 'col-md-4 mb-3 video-card';
          card.innerHTML = `
            <div class="card">
              <img src="https://${HOSTNAME}/${video.guid}.jpg" class="card-img-top" alt="Thumbnail">
              <div class="card-body">
                <h5 class="card-title">${video.title}</h5>
                <p class="card-text">Uploaded: ${new Date(video.dateUploaded * 1000).toLocaleDateString()}</p>
              </div>
            </div>
          `;
          card.onclick = () => showVideo(video);
          list.appendChild(card);
        });
      } catch (e) { alert('Error loading videos: ' + e.message); }
    }

    // Show Video Modal
    function showVideo(video) {
      document.getElementById('video-title').textContent = video.title;
      document.getElementById('video-player').src = `${IFRAME_BASE}${video.guid}?autoplay=false`;
      const modal = new bootstrap.Modal(document.getElementById('video-modal'));
      modal.show();
      document.getElementById('save-new').onclick = () => trimAndSave(video, false);
      document.getElementById('override').onclick = () => trimAndSave(video, true);
      document.getElementById('share-btn').onclick = () => {
        navigator.clipboard.writeText(`https://${HOSTNAME}/${video.guid}/playlist.m3u8`);
        alert('Direct link copied!');
      };
      document.getElementById('trim-end').value = video.length; // Assume length from video obj
    }

    // Trim and Save
    async function trimAndSave(oldVideo, isOverride) {
      const start = parseFloat(document.getElementById('trim-start').value);
      const end = parseFloat(document.getElementById('trim-end').value);
      const duration = end - start;
      if (duration <= 0) return alert('Invalid times');
      try {
        if (!ffmpeg.isLoaded()) await ffmpeg.load();
        const hlsUrl = `https://${HOSTNAME}/${oldVideo.guid}/playlist.m3u8`;
        ffmpeg.FS('writeFile', 'input.m3u8', await fetchFile(hlsUrl));
        await ffmpeg.run('-i', 'input.m3u8', '-ss', start.toString(), '-t', duration.toString(), '-bsf:a', 'aac_adtstoasc', '-vcodec', 'copy', '-acodec', 'copy', 'output.mp4');
        const data = ffmpeg.FS('readFile', 'output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        const newTitle = isOverride ? oldVideo.title : prompt('New name:', oldVideo.title + ' (trimmed)');
        const collectionId = oldVideo.collectionId || '';
        const newGuid = await uploadVideo(blob, newTitle, collectionId);
        if (isOverride) {
          // Copy metadata if needed (e.g., category already set)
          await apiCall('DELETE', `videos/${oldVideo.guid}`);
        }
        alert('Saved!');
        loadVideos();
      } catch (e) { alert('Trim failed: ' + e.message); }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      if (localStorage.getItem('loggedIn') === 'true') {
        document.getElementById('login').style.display = 'none';
        document.getElementById('home').style.display = 'block';
        await loadCollections();
        await loadVideos();
      }

      document.getElementById('login-form').addEventListener('submit', e => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if (email === 'archiejjfisher@gmail.com' && pass === 'LOGIN.DEVACC!!') {
          localStorage.setItem('loggedIn', 'true');
          document.getElementById('login').style.display = 'none';
          document.getElementById('home').style.display = 'block';
          loadCollections();
          loadVideos();
        } else {
          alert('Invalid credentials');
        }
      });

      // Filters
      document.getElementById('search-bar').addEventListener('input', e => loadVideos(e.target.value, document.getElementById('filter-select').value, document.getElementById('sort-select').value));
      document.getElementById('filter-select').addEventListener('change', e => loadVideos(document.getElementById('search-bar').value, e.target.value, document.getElementById('sort-select').value));
      document.getElementById('sort-select').addEventListener('change', e => loadVideos(document.getElementById('search-bar').value, document.getElementById('filter-select').value, e.target.value));

      // Upload
      const uploadModal = new bootstrap.Modal(document.getElementById('upload-modal'));
      document.getElementById('upload-btn').onclick = () => {
        uploadModal.show();
        document.getElementById('metadata-form').style.display = 'none';
        document.getElementById('upload-progress').style.display = 'none';
      };
      const dropZone = document.getElementById('upload-drop');
      dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
      });
      document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));

      async function handleFile(file) {
        if (!file || !file.type.startsWith('video/')) return alert('Invalid video');
        document.getElementById('metadata-form').style.display = 'block';
        document.getElementById('submit-metadata').onclick = async () => {
          const title = document.getElementById('video-name').value;
          let category = document.getElementById('video-category').value;
          if (!title || !category) return alert('Name and category required');
          let collectionId = '';
          try {
            const collections = (await apiCall('GET', 'collections?search=' + encodeURIComponent(category))).items;
            const existing = collections.find(c => c.name.toLowerCase() === category.toLowerCase());
            if (existing) {
              collectionId = existing.guid;
            } else {
              const createCol = await apiCall('POST', 'collections', { name: category });
              collectionId = createCol.guid;
            }
            document.getElementById('upload-progress').style.display = 'block';
            await uploadVideo(file, title, collectionId);
            alert('Uploaded! Encoding may take a few minutes.');
            uploadModal.hide();
            loadVideos();
          } catch (e) { alert('Upload failed: ' + e.message); }
        };
      }
    });
  </script>
</body>
</html>
